<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ===== CSS ===== -->
  <link rel="stylesheet" href="../css/Signup_page_css/SignUpPage.css" />

  <!-- ===== BOX ICONS ===== -->
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css" rel="stylesheet" />
  <link rel="shortcut icon" href="../assets/logo/Remo-icon.ico" type="image/x-icon" />
  <!--===== bootstrap cdn =====-->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
    integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <title>RemoStart Login</title>
</head>

<body>
  <div class="container-fluid row align-items-center justify-content-center ms-0 me-0 ps-0 pe-0">
    <div class="main-box col col-sm-9 col-md-7 col-lg-5 col-xxl-3">
      <!-- SIGN IN BOX -->

      <section class="form registered pt-3 pb-3" id="login-in">
        <h3 class="title">Sign In</h3>

        <div class="box ms-0 me-0 input-group flex-nowrap">
          <span class="input-group-text" id="addon-wrapping">
            <i class="bx bx-user icon"></i></span>
          <input type="text" id="Username-in" name="Username-in" placeholder="Username" required
            class="input form-control" />
        </div>

        <div class="ms-0 me-0 box input-group flex-nowrap">
          <span class="input-group-text" id="addon-wrapping">
            <i class="bx bx-lock-alt icon"></i></span>
          <input id="password-signin" type="password" name="password" placeholder="Password" minlength="4" required
            class="input form-control mb-0" />
        </div>
        <div>
          <input type="checkbox" name="rememberMe" value="Y" /> Remember me
        </div>
        <div>
          <a href="#" class="forgot" id="forgot-button">Forgot password?</a>
        </div>
        <div class="d-grid gap-2 col-6 mx-auto">
          <button type="submit" id="signinbtn" class="btn text-white">
            Sign In
          </button>
        </div>
        <div class="text-center">
          <span class="account">Don't have an Account ?</span>
          <span class="signup" id="sign-up">Sign Up</span>
        </div>
      </section>

      <!-- SIGN UP BOX -->
      <section class="form create none pt-3 pb-3" id="login-up">
        <h3 class="title">Create Account</h3>

        <div class="namebox">
          <div class="box input-group flex-nowrap ms-0 me-2">
            <span class="input-group-text" id="addon-wrapping">
              <i class="bx bx-user icon"></i>
            </span>

            <input type="text" placeholder="First name" required class="input form-control" id="Fname" name="fname" />
          </div>
          <div class="box input-group flex-nowrap ms-0 me-0">
            <span class="input-group-text" id="addon-wrapping">
              <i class="bx bx-user icon"></i>
            </span>
            <input type="text" placeholder="Last name" required class="input form-control" id="Lname" name="lname" />
          </div>
        </div>
        <div class="box input-group flex-nowrap ms-0 me-0">
          <span class="input-group-text" id="addon-wrapping">
            <i class="bx bx-at icon"></i>
          </span>
          <input type="text" placeholder="Username" required class="input form-control" id="Username" name="Username" />
        </div>
        <div class="box input-group flex-nowrap ms-0 me-0">
          <span class="input-group-text" id="addon-wrapping">
            <i class="bx bx-at icon"></i>
          </span>
          <input type="text" placeholder="Email" required class="input form-control" id="email" name="email" />
        </div>
        <div class="box input-group flex-nowrap ms-0 me-0">
          <span class="input-group-text" id="addon-wrapping">
            <i class="bx bx-phone-call icon"></i>
          </span>

          <input type="text" placeholder="Phone" required class="input form-control" id="phone" name="phone" />
        </div>

        <div class="box input-group flex-nowrap ms-0 me-0">
          <span class="input-group-text" id="addon-wrapping">
            <i class="bx bx-lock-alt icon"></i>
          </span>
          <input type="password" minlength="6" placeholder="Password" required class="input form-control" id="password"
            name="password" />
        </div>
        <div class="box input-group flex-nowrap ms-0 me-0">
          <span class="input-group-text" id="addon-wrapping">
            <i class="bx bx-lock-alt icon"></i>
          </span>
          <input type="password" minlength="6" placeholder="Re - Type Password" required class="input form-control"
            id="password-signup2" name="Password2" />
        </div>
        <div class="d-grid gap-2 col-6 mx-auto">
          <button type="submit" id="sumbitbtn" class="btn text-white">
            Sign Up
          </button>
        </div>
        <div class="text-center">
          <span class="account">Already have an Account ?</span>
          <a class="signup" id="sign-in">Sign In</a>
        </div>
      </section>

      <!-- FORGOT PASSWORD PAGE -->
      <section action="" class="form create none" id="forget-password">
        <h3 class="title">Forgot Password</h3>
        <div class="box input-group ms-0 me-0">
          <input type="text" id="enter-username" placeholder="Enter your username" class="input form-control" id="email"
            name="email" />
        </div>
        <div class="d-grid gap-2 col-6 mx-auto">
          <button type="submit" id="resetbtn" class="btn text-white">
            Reset Password
          </button>
        </div>
      </section>
    </div>
  </div>


  <script src="../js/signup_page_js/SignUpPage.js"></script>
  <!--===== BOOTSTRAP .JS =====-->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
    integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <!-- jqeuy -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

  <!--Firebase Libraries-->



  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCecdzObF4mPIJV4TMa4uoLvrnugByyriQ",
      authDomain: "remestart-11111.firebaseapp.com",
      databaseURL: "https://remestart-11111-default-rtdb.firebaseio.com",
      projectId: "remestart-11111",
      storageBucket: "remestart-11111.appspot.com",
      messagingSenderId: "197894692203",
      appId: "1:197894692203:web:62ff61e9b36cdbddfd002e",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    import {
      getDatabase,
      ref,
      set,
      child,
      get,
      onValue,
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
    // ------------------Reading Data------------
    const db = getDatabase();

    //  register user
    var Fname, Lname, Email, PhoneNo, Password, Username;

    Fname = document.getElementById("Fname");
    Lname = document.getElementById("Lname");
    Email = document.getElementById("email");
    PhoneNo = document.getElementById("phone");
    Password = document.getElementById("password");
    Username = document.getElementById("Username");
    var sumbitbtn = document
      .getElementById("sumbitbtn")
      .addEventListener("click", RegisterUser);
    function RegisterUser() {
      const dbref = ref(db);
      var newUserName = Username.value;

      if (sessionStorage.getItem("formstatus") == "incorrect") {
        alert("data incorrect");
      } else {
        get(child(dbref, "User/" + newUserName)).then((snapshot) => {
          if (snapshot.exists()) {
            alert("account already exist!", "warning", "login-up");
          } else {
            set(ref(db, "User/" + newUserName), {
              FirstName: Fname.value,
              LastName: Lname.value,
              Email: Email.value,
              PhoneNo: PhoneNo.value,
              Password: encPass(),
              Username: Username.value,
            })
              .then(() => {
                alert("Registered Successfully", "success", "login-up");
                setTimeout(function () {
                  //your code to be executed after 1 second
                  window.location = "../SignupPage/SignUpPage.html";
                }, 2000);
              })
              .catch((error) => {
                alert(error, "warning", "login-up");
              });
          }
        });
      }
    }

    // login page
    var Username_in = document.getElementById("Username-in");
    var passwordSignin = document.getElementById("password-signin");
    var signinbtn = document
      .getElementById("signinbtn")
      .addEventListener("click", AuthenticateUser);
    function AuthenticateUser() {
      const dbref = ref(db);
      get(child(dbref, "User/" + Username_in.value)).then((snapshot) => {
        if (snapshot.exists()) {

          const starCountRef = ref(
            db,
            "User/" + Username_in.value + "/Password"
          );
          onValue(starCountRef, (user_snap) => {
            let dbpass = decPass(user_snap.val());

            if (passwordSignin.value === dbpass) {

              transferJSON(snapshot.val());

              window.location = "../DashboardPage/DashboardPage.html";
            } else {
              alert("Incorrect Password", "warning", "login-in");
            }
          });
        } else {
          alert("account does not exist!", "danger", "login-in");
        }
      });
    }

    // forget password
    var forgetbtn = document
      .getElementById("resetbtn")
      .addEventListener("click", resetPassword);

    function resetPassword() {
      var forgetUsername = document.getElementById("enter-username").value;
      const dbref = ref(db);
      get(child(dbref, "User/" + forgetUsername)).then((snapshot) => {
        if (!snapshot.exists()) {
          alert("account do not exist!", "warning", 'forget-password');

        } else {
          set(ref(db, "User/" + forgetUsername + "/Password"), "U2FsdGVkX18+NDEz2LXUhrYaQ7dlmmjDDZ59Qlxa5uE=")
            .then(() => {
              alert(
                // "Your new password is U2FsdGVkX18+NDEz2LXUhrYaQ7dlmmjDDZ59Qlxa5uE=",
                "Your new password is Password@123",
                "success",
                "forget-password"
              );
              setTimeout(function () {
                window.location = "../SignupPage/SignUpPage.html";
              }, 3000);
            })
            .catch((error) => {
              alert(error, "warning");
            });
        }
      });
    }


    // encryption function

    function encPass() {
      var pass12 = CryptoJS.AES.encrypt(Password.value, Password.value);
      return pass12.toString();
    }

    // decryption fucntion
    function decPass(dbpass) {

      var pass12 = CryptoJS.AES.decrypt(dbpass, passwordSignin.value).toString(CryptoJS.enc.Utf8);

      return pass12.toString(CryptoJS.enc.Utf8);
    }

    // alert function
    function alert(message, type, btnlink) {
      var alertPlaceholder = document.getElementById(btnlink);
      var wrapper = document.createElement("div");
      wrapper.innerHTML =
        '<div class="alert alert-' +
        type +
        ' alert-dismissible" role="alert">' +
        message +
        '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';

      alertPlaceholder.append(wrapper);
    }

    // JSON transfer function

    function transferJSON(user) {
      user = JSON.stringify(user);
      sessionStorage.setItem("user", user);
    }
  </script>
</body>

</html>